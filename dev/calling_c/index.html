<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calling a Kokkos library · Kokkos.jl</title><meta name="title" content="Calling a Kokkos library · Kokkos.jl"/><meta property="og:title" content="Calling a Kokkos library · Kokkos.jl"/><meta property="twitter:title" content="Calling a Kokkos library · Kokkos.jl"/><meta name="description" content="Documentation for Kokkos.jl."/><meta property="og:description" content="Documentation for Kokkos.jl."/><meta property="twitter:description" content="Documentation for Kokkos.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Kokkos.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Usage</span><ul><li class="is-active"><a class="tocitem" href>Calling a Kokkos library</a><ul class="internal"><li><a class="tocitem" href="#Your-CMake-project"><span>Your CMake project</span></a></li><li><a class="tocitem" href="#Loading-the-wrapper-library-of-Kokkos.jl"><span>Loading the wrapper library of <code>Kokkos.jl</code></span></a></li><li><a class="tocitem" href="#Compiling-and-loading-the-library"><span>Compiling and loading the library</span></a></li></ul></li><li><a class="tocitem" href="../inaccessible_views/">Using views in an inaccessible memory space</a></li><li><a class="tocitem" href="../interop/">Interoperability with CUDA.jl and AMDGPU.jl</a></li><li><a class="tocitem" href="../MPI/">MPI</a></li></ul></li><li><a class="tocitem" href="../environment/">Environment</a></li><li><a class="tocitem" href="../spaces/">Execution &amp; Memory Spaces</a></li><li><a class="tocitem" href="../views/">Views</a></li><li><a class="tocitem" href="../compilation/">Compilation</a></li><li><a class="tocitem" href="../library_management/">Library Management</a></li><li><a class="tocitem" href="../config_options/">Configuration options</a></li><li><span class="tocitem">Internals</span><ul><li><a class="tocitem" href="../dynamic_compilation/">Dynamic Compilation</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Usage</a></li><li class="is-active"><a href>Calling a Kokkos library</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calling a Kokkos library</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Keluaa/Kokkos.jl/blob/main/docs/src/calling_c.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Calling-a-Kokkos-library"><a class="docs-heading-anchor" href="#Calling-a-Kokkos-library">Calling a Kokkos library</a><a id="Calling-a-Kokkos-library-1"></a><a class="docs-heading-anchor-permalink" href="#Calling-a-Kokkos-library" title="Permalink"></a></h1><p>Suppose we want to wrap the following function:</p><pre><code class="language-c hljs">// my_lib.cpp
#include &quot;Kokkos_Core.hpp&quot;

extern &quot;C&quot;
void fill_view(Kokkos::View&lt;double*&gt;&amp; view, double value)
{
    Kokkos::parallel_for(Kokkos::RangePolicy&lt;&gt;(0, view.size()),
    KOKKOS_LAMBDA(int i) {
        view[i] = value;
    });
}</code></pre><p>It is important to understand that here the argument type <code>Kokkos::View&lt;double*&gt;&amp;</code> relies on the default template arguments for the layout type, memory space and memory traits. Therefore, its complete type will change depending on the Kokkos configuration.</p><p>In order for <code>Kokkos.jl</code> to properly call this function, we must build a view from Julia whose type matches exactly the complete type of <code>Kokkos::View&lt;double*&gt;</code>.</p><p>The <a href="../views/#Kokkos.Views.View"><code>View</code></a> type represents such a complete view type. Its default parameters should match with those of our library, at the condition that Kokkos is configured in the same way. To achieve this you have two options:</p><ul><li>let <code>Kokkos.jl</code> configure the library and itself, guaranteeing that the options match</li><li>the library containing the function is already compiled, or you cannot/don&#39;t want to change its Kokkos configuration: you must configure <code>Kokkos.jl</code> with the exact same options</li></ul><p>When calling a Kokkos method for the first time in a Julia session, <code>Kokkos.jl</code> will compile the C++ method into a shared library, which is then loaded with <code>CxxWrap.jl</code> to be used as a Julia method. See this chapter for more info about <a href="../dynamic_compilation/#Dynamic-Compilation">Dynamic Compilation</a>.</p><h2 id="Your-CMake-project"><a class="docs-heading-anchor" href="#Your-CMake-project">Your CMake project</a><a id="Your-CMake-project-1"></a><a class="docs-heading-anchor-permalink" href="#Your-CMake-project" title="Permalink"></a></h2><p>The CMake project shouldn&#39;t need extra handling to be compatible:</p><pre><code class="language-cmake hljs"># CMakeLists.txt
cmake_minimum_required(VERSION 3.20)
project(MyLib)

# set(BUILD_SHARED_LIBS ON)  # Not mandatory, Kokkos.jl can add it automatically

find_package(Kokkos REQUIRED)

add_library(MyLib SHARED my_lib.cpp)
target_link_libraries(MyLib PRIVATE Kokkos::kokkos)  # or PUBLIC, it doesn&#39;t matter</code></pre><p><code>find_package</code> requires the <code>Kokkos_ROOT</code> (or <code>Kokkos_DIR</code>) variable to be set when configuring the project. <code>Kokkos.jl</code> can do that for you. The advantage of this approach is that your project and <code>Kokkos.jl</code> will share the same Kokkos installation, reducing the compilation time.</p><p>If your project uses Kokkos in-tree, you have several options:</p><ul><li>keep the call to <code>add_subdirectory</code> the same, and configure <a href="../config_options/#kokkos_path">kokkos_path</a> to use the same path</li><li>use <code>find_package</code> if <code>Kokkos_ROOT</code> is defined:</li></ul><pre><code class="language-cmake hljs">if (NOT DEFINED Kokkos_ROOT)
    add_subdirectory(your/kokkos/path lib/kokkos)  # Use Kokkos in-tree
else()
    find_package(Kokkos REQUIRED)  # Use the provided Kokkos installation
endif()</code></pre><p>Be aware that using another Kokkos installation from the one used by <code>Kokkos.jl</code> might lead to obscure runtime/link time errors. A good first indicator of this issue would be the CMake warning that <code>Kokkos_ROOT</code> was not used by the project.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>All libraries should use Kokkos as a shared library. To do this the cmake option <code>&quot;BUILD_SHARED_LIBS&quot;</code> must be <code>&quot;ON&quot;</code>. Failing to do so will statically link Kokkos to your library, which therefore will not share the same environment as the kokkos wrapper library. This error is invisible in most backends but will create errors in others (like Cuda). When creating a project with a <a href="../compilation/#Kokkos.CMakeKokkosProject"><code>CMakeKokkosProject</code></a>, <code>&quot;BUILD_SHARED_LIBS&quot;</code> will be properly set to <code>&quot;ON&quot;</code>.</p></div></div><h2 id="Loading-the-wrapper-library-of-Kokkos.jl"><a class="docs-heading-anchor" href="#Loading-the-wrapper-library-of-Kokkos.jl">Loading the wrapper library of <code>Kokkos.jl</code></a><a id="Loading-the-wrapper-library-of-Kokkos.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-the-wrapper-library-of-Kokkos.jl" title="Permalink"></a></h2><p><code>Kokkos.jl</code> relies on a wrapper library written in C++ to compile the basic functions of Kokkos, spaces related methods and <a href="../environment/#Environment">backend-specific functions</a>. It is configured through the <a href="../config_options/#Configuration-Options">Configuration Options</a>.</p><p>Upon loading <code>Kokkos.jl</code>, this wrapper library is not loaded (and maybe not compiled). Therefore, most Kokkos functions will not work (some methods might be missing, others will raise an error).</p><p>To load the wrapper library you can use <a href="../environment/#Kokkos.Wrapper.load_wrapper_lib"><code>Kokkos.load_wrapper_lib</code></a> or <a href="../environment/#Kokkos.initialize"><code>Kokkos.initialize</code></a>:</p><pre><code class="language-julia-repl hljs">julia&gt; using Kokkos

julia&gt; Kokkos.load_wrapper_lib()  # Will compile then load the library, it may take some time

julia&gt; Kokkos.initialize()  # Will also call `Kokkos.load_wrapper_lib()` if needed
</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The reason the wrapper library is not loaded when <code>using Kokkos</code>, is for setting the <a href="../config_options/#Configuration-Options">Configuration Options</a>. After <code>Kokkos.load_wrapper_lib()</code> has been called, the configuration options are locked, and require to restart the Julia session for changes to be applied.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Setting the environment variable <code>JULIA_DEBUG</code> to <code>Kokkos</code> will print all steps and commands called to compile and load the wrapper library, as well as for user libraries.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Upon closing the Julia session, <a href="../environment/#Kokkos.finalize"><code>Kokkos.finalize</code></a> will be called if needed.</p></div></div><h2 id="Compiling-and-loading-the-library"><a class="docs-heading-anchor" href="#Compiling-and-loading-the-library">Compiling and loading the library</a><a id="Compiling-and-loading-the-library-1"></a><a class="docs-heading-anchor-permalink" href="#Compiling-and-loading-the-library" title="Permalink"></a></h2><p>By default, when loading <code>Kokkos.jl</code> the build files will be stored in a scratch directory, this can be configured with <a href="../config_options/#build_dir">build_dir</a>. It is recommended to build the project files to the same directory, by using the <code>Kokkos.KOKKOS_BUILD_DIR</code> variable. In order for the <a href="../config_options/#Configuration-Options">Configuration Options</a> to be passed correctly, you should use a <a href="../compilation/#Kokkos.CMakeKokkosProject"><code>CMakeKokkosProject</code></a>:</p><pre><code class="language-julia-repl hljs">julia&gt; my_lib_path = &quot;./path/to/mylib/project&quot;
&quot;./path/to/mylib/project&quot;

julia&gt; my_lib_build_path = joinpath(Kokkos.KOKKOS_BUILD_DIR, &quot;mylib&quot;)
&quot;/path/to/scratch/.kokkos-build/mylib&quot;

julia&gt; project = CMakeKokkosProject(my_lib_path, &quot;libMyLib&quot;;
                                    target=&quot;MyLib&quot;, build_dir=my_lib_build_path)
Kokkos project from sources located at &#39;./path/to/mylib/project&#39;
Building in &#39;/path/to/scratch.kokkos-build/mylib&#39;
...</code></pre><p>If <code>target</code> is not given, <code>CMakeKokkosProject</code> will build by default all targets of the CMake project. Here <code>&quot;libMyLib&quot;</code> is the name of the result of the <code>MyLib</code> target: the library we want to compile and load.</p><pre><code class="language-julia-repl hljs">julia&gt; compile(project)

julia&gt; my_lib = load_lib(project)
CLibrary(...)</code></pre><p>The library can then be used the same way as you would with a shared library. Use <a href="../library_management/#Kokkos.handle"><code>handle</code></a> to get a pointer to pass to <code>Libdl.dlsym</code> or use <a href="../library_management/#Kokkos.get_symbol"><code>get_symbol</code></a> to get the address of our <code>fill_view</code> function:</p><pre><code class="language-julia-repl hljs">julia&gt; v = Kokkos.View{Float64}(undef, 10)
10-element Kokkos.Views.View{Float64, 1, Kokkos.LayoutRight, Kokkos.HostSpace}:
 6.365987373e-314
 1.14495326e-316
...

julia&gt; ccall(get_symbol(my_lib, :fill_view),
             Cvoid, (Ref{Kokkos.View}, Float64),
             v, 0.1)

julia&gt; v
10-element Kokkos.Views.View{Float64, 1, Kokkos.LayoutRight, Kokkos.HostSpace}:
 0.1
 0.1
...</code></pre><p>Here we called <code>void fill_view(Kokkos::View&lt;double&gt;&amp;, double)</code>, which has been compiled with a <em>single</em> set of template arguments for <code>Kokkos::View</code>. Therefore the <code>ccall</code> is only valid if the view passed to it matches exactly those template arguments. You can further specify the argument types of the <code>ccall</code> to reflect this:</p><pre><code class="language-julia-repl hljs">julia&gt; ccall(get_symbol(my_lib, :fill_view),
             Cvoid, (Ref{Kokkos.View{Float64, 1, Kokkos.DEFAULT_DEVICE_MEM_SPACE}}, Float64),
             v, 0.1)</code></pre><p>The library is opened in a way which allows it to be unloaded afterward using <a href="../library_management/#Kokkos.unload_lib"><code>unload_lib</code></a>:</p><pre><code class="language-julia-repl hljs">julia&gt; unload_lib(my_lib)
true

julia&gt; is_lib_loaded(my_lib)
false</code></pre><p>This can be useful in order to reconfigure and recompile the project in the same session, to perform compilation parameters exploration for example. As long as all views are allocated through <code>Kokkos.jl</code>, they can be safely re-used after a library reload.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>The full types of views (such as <code>Kokkos.Views.Impl1.View1D_R_HostAllocated{Float64}</code>) is ugly and can change from one session to another. Do not rely on such types.</p><p>Use <a href="../views/#Kokkos.Views.main_view_type"><code>Views.main_view_type</code></a> to get a more pleasant and stable type:</p><pre><code class="language-julia hljs">julia&gt; Kokkos.main_view_type(v)  # or `Kokkos.main_view_type(typeof(v))`
Kokkos.Views.View{Float64, 1, Kokkos.LayoutRight, Kokkos.HostSpace}</code></pre></div></div><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>If any view which has been allocated by an external library is owned by Julia (i.e. in the case where it is Julia which should call the destructor), it <em>must</em> be finalized before unloading the library (i.e. either <a href="https://docs.julialang.org/en/v1/base/base/#Base.finalize"><code>finalize</code></a> must be called on the view, or the garbage collector did so automatically beforehand).</p><p>Failure to do so will result in nasty segfaults when the GC tries to call the finalizer on the view, which also happens when Julia is exiting.</p><p>The segfault could look like this:</p><pre><code class="nohighlight hljs">signal (11): Segmentation error
in expression starting at /home/Kokkos/test/runtests.jl:19
unknown function (ip: 0x7f928f488090)
_ZN6Kokkos4Impl22SharedAllocationRecordIvvE9decrementEPS2_ at /home/Kokkos/.kokkos-build/wrapper-build-release/lib/kokkos/core/src/libkokkoscore.so.4.0 (unknown line)</code></pre><p>The main clue that it is a finalizer error is the fact it happens in <code>Kokkos::Impl::SharedAllocationRecord::decrement</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../inaccessible_views/">Using views in an inaccessible memory space »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 24 January 2024 08:20">Wednesday 24 January 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
