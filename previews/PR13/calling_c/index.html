<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calling a Kokkos library · Kokkos.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Kokkos.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Usage</span><ul><li class="is-active"><a class="tocitem" href>Calling a Kokkos library</a><ul class="internal"><li><a class="tocitem" href="#Your-CMake-project"><span>Your CMake project</span></a></li><li><a class="tocitem" href="#Loading-the-wrapper-library-of-Kokkos.jl"><span>Loading the wrapper library of <code>Kokkos.jl</code></span></a></li><li><a class="tocitem" href="#Compiling-and-loading-the-library"><span>Compiling and loading the library</span></a></li></ul></li><li><a class="tocitem" href="../inaccessible_views/">Using views in an inaccessible memory space</a></li></ul></li><li><a class="tocitem" href="../environment/">Environment</a></li><li><a class="tocitem" href="../spaces/">Execution &amp; Memory Spaces</a></li><li><a class="tocitem" href="../views/">Views</a></li><li><a class="tocitem" href="../compilation/">Compilation</a></li><li><a class="tocitem" href="../library_management/">Library Management</a></li><li><a class="tocitem" href="../config_options/">Configuration options</a></li><li><a class="tocitem" href="../MPI/">MPI</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Usage</a></li><li class="is-active"><a href>Calling a Kokkos library</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calling a Kokkos library</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Keluaa/Kokkos.jl/blob/main/docs/src/calling_c.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Calling-a-Kokkos-library"><a class="docs-heading-anchor" href="#Calling-a-Kokkos-library">Calling a Kokkos library</a><a id="Calling-a-Kokkos-library-1"></a><a class="docs-heading-anchor-permalink" href="#Calling-a-Kokkos-library" title="Permalink"></a></h1><p>Suppose we want to wrap the following function:</p><pre><code class="language-c hljs">// my_lib.cpp
#include &quot;Kokkos_Core.hpp&quot;

extern &quot;C&quot;
void fill_view(Kokkos::View&lt;double*&gt;&amp; view, double value)
{
    Kokkos::parallel_for(Kokkos::RangePolicy&lt;&gt;(0, view.size()),
    KOKKOS_LAMBDA(int i) {
        view[i] = value;
    });
}</code></pre><p>It is important to understand that here the argument type <code>Kokkos::View&lt;double*&gt;&amp;</code> relies on the default template arguments for the layout type, memory space and memory traits. Therefore, its complete type will change depending on the Kokkos configuration.</p><p>In order for <code>Kokkos.jl</code> to properly call this function, we must build a view from Julia whose type matches exactly the complete type of <code>Kokkos::View&lt;double*&gt;</code>. This requires <code>Kokkos.jl</code> to compile some member functions of the complete <code>Kokkos::View</code> type, as well as its constructors.</p><p>To achieve this you have two options:</p><ul><li>let <code>Kokkos.jl</code> configure the library and itself, guaranteeing that the options match</li><li>the library containing the function is already compiled, or you cannot/don&#39;t want to change its Kokkos configuration: you must configure <code>Kokkos.jl</code> with the exact same options</li></ul><p>In both cases, this is how you can configure <code>Kokkos.jl</code> for:</p><ul><li>the element type: must be present in <a href="../config_options/#view_types">view_types</a></li><li>the dimension: must be present in <a href="../config_options/#view_dims">view_dims</a></li><li>the <a href="../views/#Kokkos.Views.Layout"><code>Layout</code></a>: must be present in <a href="../config_options/#view_layouts">view_layouts</a></li><li>the <a href="../spaces/#Kokkos.Spaces.MemorySpace"><code>MemorySpace</code></a>: configured through the <a href="../config_options/#backends">backends</a> options</li><li>the memory traits: not yet implemented</li></ul><p>All possible combinations of those parameters are compiled when loading <code>Kokkos.jl</code>. For example, if <code>view_types = [Float64, Float32]</code>, <code>view_dims = [1, 2]</code>, <code>view_layouts = [&quot;left&quot;, &quot;right&quot;]</code> and <code>backends = [Serial, Cuda]</code>, there will be a total of <code>2×2×2×2 = 16</code> different views compiled.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Your project is not affected by the <a href="../config_options/#view_dims">view_dims</a>, <a href="../config_options/#view_types">view_types</a> and <a href="../config_options/#view_layouts">view_layouts</a> options. You only need to make sure that the combination of those options cover all usages of views in your project.</p></div></div><h2 id="Your-CMake-project"><a class="docs-heading-anchor" href="#Your-CMake-project">Your CMake project</a><a id="Your-CMake-project-1"></a><a class="docs-heading-anchor-permalink" href="#Your-CMake-project" title="Permalink"></a></h2><p>The CMake project shouldn&#39;t need extra handling:</p><pre><code class="language-cmake hljs"># CMakeLists.txt
cmake_minimum_required(VERSION 3.20)
project(MyLib)

set(CMAKE_CXX_EXTENSIONS OFF)  # Kokkos will warn you if this is not set to OFF

find_package(Kokkos REQUIRED)

add_library(MyLib SHARED my_lib.cpp)
target_link_libraries(MyLib PRIVATE Kokkos::kokkos)  # or PUBLIC, it doesn&#39;t matter</code></pre><p><code>find_package</code> requires the <code>Kokkos_ROOT</code> (or <code>Kokkos_DIR</code>) variable to be set when configuring the project. <code>Kokkos.jl</code> can do that for you. The advantage of this approach is that your project and <code>Kokkos.jl</code> will share the same Kokkos installation, reducing the compilation time.</p><p>If your project uses Kokkos in-tree, you have several options: </p><ul><li>keep the call to <code>add_subdirectory</code> the same, and configure <a href="../config_options/#kokkos_path">kokkos_path</a> to use the same path</li><li>change it to <code>add_subdirectory(${Kokkos_ROOT} lib/kokkos)</code> (the second argument is arbitrary)</li></ul><h2 id="Loading-the-wrapper-library-of-Kokkos.jl"><a class="docs-heading-anchor" href="#Loading-the-wrapper-library-of-Kokkos.jl">Loading the wrapper library of <code>Kokkos.jl</code></a><a id="Loading-the-wrapper-library-of-Kokkos.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-the-wrapper-library-of-Kokkos.jl" title="Permalink"></a></h2><p><code>Kokkos.jl</code> relies on a wrapper library written in C++ to compile all possible combinations of <code>Kokkos::View</code>, as described by the <a href="../config_options/#Configuration-Options">Configuration Options</a>, as well as all <a href="../spaces/#Kokkos.Spaces.ExecutionSpace"><code>ExecutionSpace</code></a>, <a href="../spaces/#Kokkos.Spaces.MemorySpace"><code>MemorySpace</code></a> needed and <a href="../environment/#Environment">other functions</a>.</p><p>Upon loading <code>Kokkos.jl</code>, this wrapper library is not loaded (and maybe not compiled). Therefore, most Kokkos functions will not work (some methods might be missing, others will raise an error).</p><p>To load the wrapper library you can use <a href="../environment/#Kokkos.KokkosWrapper.load_wrapper_lib"><code>Kokkos.load_wrapper_lib</code></a> or <a href="../environment/#Kokkos.initialize"><code>Kokkos.initialize</code></a>:</p><pre><code class="language-julia-repl hljs">julia&gt; using Kokkos

julia&gt; Kokkos.load_wrapper_lib()  # Will compile then load the library, it may take some time

julia&gt; Kokkos.initialize()  # Will also call `Kokkos.load_wrapper_lib()` if needed
</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The reason the wrapper library is not loaded when <code>using Kokkos</code>, is for setting the <a href="../config_options/#Configuration-Options">Configuration Options</a>. After <code>Kokkos.load_wrapper_lib()</code> has been called, the configuration options are locked, and require to restart the Julia session for changes to be applied.</p></div></div><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Setting the environment variable <code>JULIA_DEBUG</code> to <code>Kokkos</code> will print all steps and commands called to compile and load the wrapper library, as well as for user libraries.</p></div></div><h2 id="Compiling-and-loading-the-library"><a class="docs-heading-anchor" href="#Compiling-and-loading-the-library">Compiling and loading the library</a><a id="Compiling-and-loading-the-library-1"></a><a class="docs-heading-anchor-permalink" href="#Compiling-and-loading-the-library" title="Permalink"></a></h2><p>By default, when loading <code>Kokkos.jl</code> the build files will be stored in a scratch directory, this can be configured with <a href="../config_options/#build_dir">build_dir</a>. It is recommended to build the project files to the same directory, by using the <code>Kokkos.KOKKOS_BUILD_DIR</code> variable. In order for the <a href="../config_options/#Configuration-Options">Configuration Options</a> to be passed correctly, you should use a <code>CMakeKokkosProject</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; my_lib_path = &quot;./path/to/mylib/project&quot;
&quot;./path/to/mylib/project&quot;

julia&gt; my_lib_build_path = joinpath(Kokkos.KOKKOS_BUILD_DIR, &quot;mylib&quot;)
&quot;/path/to/scratch/.kokkos-build/mylib&quot;

julia&gt; project = CMakeKokkosProject(my_lib_path, &quot;libMyLib&quot;;
                                    target=&quot;MyLib&quot;, build_dir=my_lib_build_path)
Kokkos project from sources located at &#39;./path/to/mylib/project&#39;
Building in &#39;/path/to/scratch.kokkos-build/mylib&#39;
...</code></pre><p>If <code>target</code> is not given, <code>CMakeKokkosProject</code> will build by default all targets of the CMake project. Here <code>&quot;libMyLib&quot;</code> is the name of the result of the <code>MyLib</code> target: the library we want to compile and load.</p><pre><code class="language-julia-repl hljs">julia&gt; compile(project)

julia&gt; my_lib = load_lib(project)
CLibrary(...)</code></pre><p>The library can then be used the same way as you would with a shared library. Use <a href="../library_management/#Kokkos.handle"><code>handle</code></a> to get a pointer to pass to <code>Libdl.dlsym</code> or use <a href="../library_management/#Kokkos.get_symbol"><code>get_symbol</code></a> to get the address of our <code>fill_view</code> function:</p><pre><code class="language-julia-repl hljs">julia&gt; v = Kokkos.View{Float64}(undef, 10)
10-element Kokkos.Views.View1D_HostAllocated{Float64}:
 6.365987373e-314
 1.14495326e-316
...

julia&gt; ccall(get_symbol(my_lib, :fill_view),
             Cvoid, (Ref{Kokkos.View}, Float64),
             v, 0.1)

julia&gt; v
10-element Kokkos.Views.View1D_HostAllocated{Float64}:
 0.1
 0.1
...</code></pre><p>Here we called <code>void fill_view(Kokkos::View&lt;double&gt;&amp;, double)</code>, which has been compiled with a <em>single</em> set of template arguments for <code>Kokkos::View</code>. Therefore the <code>ccall</code> is only valid if the view passed to it matches exactly those template arguments. You can further specify the argument types of the <code>ccall</code> to reflect this:</p><pre><code class="language-julia-repl hljs">julia&gt; ccall(get_symbol(my_lib, :fill_view),
             Cvoid, (Ref{Kokkos.View{Float64, 1, Kokkos.DEFAULT_DEVICE_MEM_SPACE}}, Float64),
             v, 0.1)</code></pre><p>The library is opened in a way which allows it to be unloaded afterward using <a href="../library_management/#Kokkos.unload_lib"><code>unload_lib</code></a>:</p><pre><code class="language-julia-repl hljs">julia&gt; unload_lib(my_lib)
true

julia&gt; is_lib_loaded(my_lib)
false</code></pre><p>This can be useful in order to reconfigure and recompile the project in the same session, to perform compilation parameters exploration for example. As long as all views are allocated through <code>Kokkos.jl</code>, they can be safely re-used after a library reload.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>If any view which has been allocated by an external library is owned by Julia, it <em>must</em> be finalized before unloading the library (i.e. either <a href="https://docs.julialang.org/en/v1/base/base/#Base.finalize"><code>finalize</code></a> must be called on the view, or the garbage collector did so automatically beforehand).</p><p>Failure to do so will result in nasty segfaults when the GC tries to call the finalizer on the view, which also happens when Julia is exiting.</p><p>The segfault could look like this:</p><pre><code class="nohighlight hljs">signal (11): Segmentation error
in expression starting at /home/Kokkos/test/runtests.jl:19
unknown function (ip: 0x7f928f488090)
_ZN6Kokkos4Impl22SharedAllocationRecordIvvE9decrementEPS2_ at /home/Kokkos/.kokkos-build/wrapper-build-release/lib/kokkos/core/src/libkokkoscore.so.4.0 (unknown line)</code></pre><p>The main clue that it is a finalizer error is the fact it happens in <code>Kokkos::Impl::SharedAllocationRecord::decrement</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../inaccessible_views/">Using views in an inaccessible memory space »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Monday 22 May 2023 13:12">Monday 22 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
