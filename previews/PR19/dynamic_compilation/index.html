<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Dynamic Compilation · Kokkos.jl</title><meta name="title" content="Dynamic Compilation · Kokkos.jl"/><meta property="og:title" content="Dynamic Compilation · Kokkos.jl"/><meta property="twitter:title" content="Dynamic Compilation · Kokkos.jl"/><meta name="description" content="Documentation for Kokkos.jl."/><meta property="og:description" content="Documentation for Kokkos.jl."/><meta property="twitter:description" content="Documentation for Kokkos.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Kokkos.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Usage</span><ul><li><a class="tocitem" href="../calling_c/">Calling a Kokkos library</a></li><li><a class="tocitem" href="../inaccessible_views/">Using views in an inaccessible memory space</a></li><li><a class="tocitem" href="../interop/">Interoperability with CUDA.jl and AMDGPU.jl</a></li><li><a class="tocitem" href="../MPI/">MPI</a></li></ul></li><li><a class="tocitem" href="../environment/">Environment</a></li><li><a class="tocitem" href="../spaces/">Execution &amp; Memory Spaces</a></li><li><a class="tocitem" href="../views/">Views</a></li><li><a class="tocitem" href="../compilation/">Compilation</a></li><li><a class="tocitem" href="../library_management/">Library Management</a></li><li><a class="tocitem" href="../config_options/">Configuration options</a></li><li><span class="tocitem">Internals</span><ul><li class="is-active"><a class="tocitem" href>Dynamic Compilation</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Internals</a></li><li class="is-active"><a href>Dynamic Compilation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Dynamic Compilation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Keluaa/Kokkos.jl/blob/main/docs/src/dynamic_compilation.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Dynamic-Compilation"><a class="docs-heading-anchor" href="#Dynamic-Compilation">Dynamic Compilation</a><a id="Dynamic-Compilation-1"></a><a class="docs-heading-anchor-permalink" href="#Dynamic-Compilation" title="Permalink"></a></h1><p>Functions used to compile on demand the Kokkos functions needed.</p><p>This mechanism allows to create new methods without degrading performance (after method  invalidation).</p><p>Only functions operating on views are dynamically compiled, the rest are compiled with the wrapper library.</p><p>Compilation is not thread-safe and must be done by a single process (and single thread) at once. This is ensured by <a href="#Kokkos.DynamicCompilation.compilation_lock"><code>compilation_lock</code></a>.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.@compile_and_call" href="#Kokkos.DynamicCompilation.@compile_and_call"><code>Kokkos.DynamicCompilation.@compile_and_call</code></a> — <span class="docstring-category">Macro</span></header><section><div><pre><code class="language-julia hljs">@compile_and_call(method, args, compile)</code></pre><p>If <a href="#Kokkos.DynamicCompilation.has_specialization"><code>has_specialization(method, args)</code></a> then invoke <code>method</code>, otherwise <code>compile</code> is executed. In both cases, <code>method</code> is invoked through <code>Base.invokelatest</code>.</p><p>This handles the following case:</p><pre><code class="nohighlight hljs">function my_method(@nospecialize(x))
    return @compile_and_call(my_method, x, begin #= ... =# end)
end

function my_program(x)
    my_method(x)  # Will compile
    my_method(x)
end</code></pre><p>Here the second invocation of <code>my_method</code> is still done in the same world in which <code>my_program</code> was invoked, even though the first invocation increased the global world counter. Therefore, we need to ensure <code>method</code> has not been specialized in the latest world before trying to compile.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L356-L379">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.compile_and_load" href="#Kokkos.DynamicCompilation.compile_and_load"><code>Kokkos.DynamicCompilation.compile_and_load</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">compile_and_load(current_module, cmake_target; kwargs...)</code></pre><p>Check if the library of <code>cmake_target</code> compiled with <code>kwargs</code> exists, if not compile it, then load it.</p><p>The library is a CxxWrap module, which is then loaded into <code>current_module</code> in the sub-module <code>Impl&lt;number&gt;</code> with &#39;&lt;number&gt;&#39; the total count of calls to <code>compile_and_load</code> in this Julia session.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L237-L245">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.has_specialization" href="#Kokkos.DynamicCompilation.has_specialization"><code>Kokkos.DynamicCompilation.has_specialization</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">has_specialization(func, args_t::Tuple{Vararg{Type}})</code></pre><p>True if the most specific method of <code>func</code> applicable to <code>args_t</code> has no <code>@nospecialize</code> annotation on any argument.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L331-L336">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.call_more_specific" href="#Kokkos.DynamicCompilation.call_more_specific"><code>Kokkos.DynamicCompilation.call_more_specific</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">call_more_specific(func, args)</code></pre><p>Call <code>func</code> with <code>args</code> with <code>Base.invokelatest(func, args...)</code>, but only if there is a specialized method for the arguments (an error is raised otherwise).</p><p>After calling <a href="#Kokkos.DynamicCompilation.compile_and_load"><code>compile_and_load</code></a> from a <code>@nospecialize</code> method meant to define a new method specialized for <code>args</code>, this function will prevent infinite recursion if the new method is not applicable to <code>args</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L311-L320">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.clean_libs" href="#Kokkos.DynamicCompilation.clean_libs"><code>Kokkos.DynamicCompilation.clean_libs</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">clean_libs()</code></pre><p>Remove all shared libraries generated for compilation on demand of some methods or types.</p><p>Libraries are not unloaded, therefore subsequent calls to <a href="#Kokkos.DynamicCompilation.compile_and_load"><code>compile_and_load</code></a> might not trigger recompilation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L41-L48">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Kokkos.DynamicCompilation.compilation_lock" href="#Kokkos.DynamicCompilation.compilation_lock"><code>Kokkos.DynamicCompilation.compilation_lock</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">compilation_lock(func)</code></pre><p>Asserts that only a single process (and single thread) is compiling at once.</p><p>By default, there is only a lock on tasks of the current process.</p><p>If <code>MPI.jl</code> is loaded, a PID lock file is also used (see <a href="https://docs.julialang.org/en/v1/stdlib/FileWatching/#Pidfile">FileWatching.Pidfile</a>, or <a href="https://github.com/vtjnash/Pidfile.jl">Pidfile.jl</a> before 1.9). Lock files have the advantage that no collective MPI operations are needed, however they only work if all MPI ranks share the same filesystem, and if this is not the case then there is no need for lock files. This can be overloaded with the <code>JULIA_KOKKOS_USE_COMPILATION_LOCK_FILE</code> environment variable.</p><p>Note that it is not the current process&#39; ID that is used in the PID lock file, since PID are not guaranteed to be unique in a MPI application. Instead a random 32-bit number is used, constant for this process.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Keluaa/Kokkos.jl/blob/3d6653135ba76c09233b2bf5d861e44758be55ae/src/dynamic_compilation.jl#L73-L91">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../config_options/">« Configuration options</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 4 January 2024 15:52">Thursday 4 January 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
